{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ ‚Äî VK IP Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.85rem; cursor: pointer;">
            <input type="checkbox" id="auto-refresh" style="cursor: pointer;">
            –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        </label>
        <span id="last-update" style="color: #64748b; font-size: 0.9rem;" data-time="{{ last_update or '' }}">
            {% if last_update %}
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ...
            {% else %}
            –ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å
            {% endif %}
        </span>
        <button id="refresh-btn" class="btn btn-primary" onclick="refreshStatus()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">–í—Å–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–æ–≤</div>
        <div class="value">{{ total_scripts }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–†–∞–±–æ—Ç–∞—é—Ç</div>
        <div class="value" style="color: #10b981;" id="running-count">{{ running_scripts }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
        <div class="value" style="color: #ef4444;" id="stopped-count">{{ total_scripts - running_scripts }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–°–µ—Ä–≤–µ—Ä–æ–≤</div>
        <div class="value">{{ servers|length }}</div>
    </div>
</div>

<div class="card">
    <h2>üñ• –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã</h2>
    
    {% if scripts_info %}
    <table>
        <thead>
            <tr>
                <th>–°–µ—Ä–≤–µ—Ä</th>
                <th>–°–∫—Ä–∏–ø—Ç</th>
                <th>–ê–∫–∫–∞—É–Ω—Ç / –ü—Ä–æ–µ–∫—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–¶–∏–∫–ª–æ–≤</th>
                <th>–£—Å–ø–µ—Ö–æ–≤</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π IP</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="scripts-table">
            {% for item in scripts_info %}
            <tr id="row-{{ item.server_id }}-{{ item.script.id }}" data-server="{{ item.server_id }}" data-script="{{ item.script.id }}">
                <td>{{ item.server }}</td>
                <td>{{ item.script.name }}</td>
                <td class="account-cell" style="font-size: 0.8rem; color: #94a3b8; line-height: 1.3;">
                    <div>{{ item.status.account or '-' }}</div>
                    <div style="color: #64748b;">{{ item.status.project or '-' }}</div>
                </td>
                <td class="status-cell">
                    {% if item.status.error %}
                    <span class="badge badge-yellow" style="cursor:help;" title="{{ item.status.error }}">‚ö†Ô∏è –û—à–∏–±–∫–∞</span>
                    {% elif item.status.running %}
                    <span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>
                    {% elif item.status %}
                    <span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                    {% else %}
                    <span class="badge" style="background: rgba(100,116,139,0.2); color: #64748b;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    {% endif %}
                </td>
                <td class="cycles-cell">{{ item.status.cycles or '-' }}</td>
                <td class="success-cell">{{ item.status.success or '-' }}</td>
                <td class="ip-cell">
                    {% if item.status.last_ip %}
                    <code class="ip-code">{{ item.status.last_ip }}</code>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="actions-cell">
                    <div class="actions">
                        {% if item.status.running %}
                        <button type="button" class="btn btn-secondary btn-sm" 
                                onclick="scriptAction({{ item.server_id }}, {{ item.script.id }}, 'stop', this)">
                            –°—Ç–æ–ø
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm"
                                onclick="scriptAction({{ item.server_id }}, {{ item.script.id }}, 'restart', this)">
                            –†–µ—Å—Ç–∞—Ä—Ç
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-primary btn-sm"
                                onclick="scriptAction({{ item.server_id }}, {{ item.script.id }}, 'start', this)">
                            –°—Ç–∞—Ä—Ç
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">
        <p>–°–∫—Ä–∏–ø—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
        <a href="/servers" class="btn btn-primary" style="margin-top: 1rem;">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
const TOTAL_SCRIPTS = {{ total_scripts }};
let autoRefreshInterval = null;

function timeAgo(dateStr) {
    if (!dateStr) return '–ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å';
    
    // –ü–∞—Ä—Å–∏–º –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (—Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ)
    const date = new Date(dateStr.replace(' ', 'T'));
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 0) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (seconds < 120) return '1 –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 7200) return '1 —á–∞—Å –Ω–∞–∑–∞–¥';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' —á –Ω–∞–∑–∞–¥';
    return Math.floor(seconds / 86400) + ' –¥–Ω –Ω–∞–∑–∞–¥';
}

function updateTimeAgo() {
    const el = document.getElementById('last-update');
    const time = el.dataset.time;
    if (time) {
        el.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + timeAgo(time);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
updateTimeAgo();
setInterval(updateTimeAgo, 60000);

async function refreshStatus() {
    const btn = document.getElementById('refresh-btn');
    const lastUpdate = document.getElementById('last-update');
    
    btn.disabled = true;
    btn.classList.add('btn-loading');
    lastUpdate.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    
    try {
        const res = await fetch('/api/refresh', { method: 'POST' });
        const data = await res.json();
        
        if (data.ok) {
            lastUpdate.dataset.time = data.last_update;
            updateTimeAgo();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
            document.getElementById('running-count').textContent = data.running;
            document.getElementById('stopped-count').textContent = TOTAL_SCRIPTS - data.running;
            
            showToast(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.running} —Ä–∞–±–æ—Ç–∞—é—Ç`, 'success');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}

async function scriptAction(serverId, scriptId, action, btn) {
    const actionNames = {
        'start': '–ó–∞–ø—É—Å–∫',
        'stop': '–û—Å—Ç–∞–Ω–æ–≤–∫–∞', 
        'restart': '–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫'
    };
    
    btn.disabled = true;
    btn.classList.add('btn-loading');
    
    try {
        const res = await fetch(`/servers/${serverId}/scripts/${scriptId}/${action}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();
        
        if (data.ok) {
            showToast(`${actionNames[action]}: —É—Å–ø–µ—à–Ω–æ`, 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
            updateRowStatus(serverId, scriptId, data.running);
        } else {
            showToast(`–û—à–∏–±–∫–∞: ${data.error || data.message}`, 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}

function updateRowStatus(serverId, scriptId, running) {
    const row = document.getElementById(`row-${serverId}-${scriptId}`);
    if (!row) return;
    
    const statusCell = row.querySelector('.status-cell');
    const actionsCell = row.querySelector('.actions-cell');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    if (running) {
        statusCell.innerHTML = '<span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>';
        actionsCell.innerHTML = `
            <div class="actions">
                <button type="button" class="btn btn-secondary btn-sm" 
                        onclick="scriptAction(${serverId}, ${scriptId}, 'stop', this)">
                    –°—Ç–æ–ø
                </button>
                <button type="button" class="btn btn-secondary btn-sm"
                        onclick="scriptAction(${serverId}, ${scriptId}, 'restart', this)">
                    –†–µ—Å—Ç–∞—Ä—Ç
                </button>
            </div>
        `;
    } else {
        statusCell.innerHTML = '<span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
        actionsCell.innerHTML = `
            <div class="actions">
                <button type="button" class="btn btn-primary btn-sm"
                        onclick="scriptAction(${serverId}, ${scriptId}, 'start', this)">
                    –°—Ç–∞—Ä—Ç
                </button>
            </div>
        `;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
    updateCounters();
}

function updateCounters() {
    const rows = document.querySelectorAll('#scripts-table tr');
    let running = 0;
    
    rows.forEach(row => {
        const badge = row.querySelector('.badge-green');
        if (badge) running++;
    });
    
    document.getElementById('running-count').textContent = running;
    document.getElementById('stopped-count').textContent = TOTAL_SCRIPTS - running;
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
document.getElementById('auto-refresh').addEventListener('change', function() {
    if (this.checked) {
        showToast('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (30 —Å–µ–∫)', 'info');
        autoRefreshInterval = setInterval(refreshStatus, 30000);
    } else {
        showToast('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ', 'info');
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
});
</script>
{% endblock %}
