{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ ‚Äî VK IP Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span id="last-update" style="color: #64748b; font-size: 0.9rem;" data-time="{{ last_update or '' }}">
            {% if last_update %}
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ...
            {% else %}
            –ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å
            {% endif %}
        </span>
        <button id="refresh-btn" class="btn btn-primary" onclick="refreshStatus()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">–í—Å–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–æ–≤</div>
        <div class="value">{{ total_scripts }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–†–∞–±–æ—Ç–∞—é—Ç</div>
        <div class="value" style="color: #10b981;" id="running-count">{{ running_scripts }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
        <div class="value" style="color: #ef4444;" id="stopped-count">{{ total_scripts - running_scripts }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–°–µ—Ä–≤–µ—Ä–æ–≤</div>
        <div class="value">{{ servers|length }}</div>
    </div>
</div>

<div class="card">
    <h2>üñ• –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã</h2>
    
    {% if scripts_info %}
    <table>
        <thead>
            <tr>
                <th>–°–µ—Ä–≤–µ—Ä</th>
                <th>–°–∫—Ä–∏–ø—Ç</th>
                <th>–ê–∫–∫–∞—É–Ω—Ç / –ü—Ä–æ–µ–∫—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–¶–∏–∫–ª–æ–≤</th>
                <th>–£—Å–ø–µ—Ö–æ–≤</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π IP</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="scripts-table">
            {% for item in scripts_info %}
            <tr id="row-{{ item.server_id }}-{{ item.script.id }}">
                <td>{{ item.server }}</td>
                <td>{{ item.script.name }}</td>
                <td class="account-cell" style="font-size: 0.8rem; color: #94a3b8; line-height: 1.3;">
                    <div>{{ item.status.account or '-' }}</div>
                    <div style="color: #64748b;">{{ item.status.project or '-' }}</div>
                </td>
                <td class="status-cell">
                    {% if item.status.error %}
                    <span class="badge badge-yellow" style="cursor:help;" title="{{ item.status.error }}">‚ö†Ô∏è {{ item.status.error[:30] }}...</span>
                    {% elif item.status.running %}
                    <span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>
                    {% elif item.status %}
                    <span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                    {% else %}
                    <span class="badge" style="background: rgba(100,116,139,0.2); color: #64748b;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    {% endif %}
                </td>
                <td class="cycles-cell">{{ item.status.cycles or '-' }}</td>
                <td class="success-cell">{{ item.status.success or '-' }}</td>
                <td class="ip-cell">
                    {% if item.status.last_ip %}
                    <code class="ip-code">{{ item.status.last_ip }}</code>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="actions-cell">
                    <div class="actions">
                        {% if item.status.running %}
                        <form method="POST" action="/servers/{{ item.server_id }}/scripts/{{ item.script.id }}/stop" style="display:inline;">
                            <button type="submit" class="btn btn-secondary btn-sm">–°—Ç–æ–ø</button>
                        </form>
                        <form method="POST" action="/servers/{{ item.server_id }}/scripts/{{ item.script.id }}/restart" style="display:inline;">
                            <button type="submit" class="btn btn-secondary btn-sm">–†–µ—Å—Ç–∞—Ä—Ç</button>
                        </form>
                        {% else %}
                        <form method="POST" action="/servers/{{ item.server_id }}/scripts/{{ item.script.id }}/start" style="display:inline;">
                            <button type="submit" class="btn btn-primary btn-sm">–°—Ç–∞—Ä—Ç</button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">
        <p>–°–∫—Ä–∏–ø—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
        <a href="/servers" class="btn btn-primary" style="margin-top: 1rem;">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function timeAgo(dateStr) {
    if (!dateStr) return '–ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å';
    
    const date = new Date(dateStr.replace(' ', 'T') + 'Z');
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (seconds < 120) return '1 –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 7200) return '1 —á–∞—Å –Ω–∞–∑–∞–¥';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' —á –Ω–∞–∑–∞–¥';
    if (seconds < 172800) return '1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥';
    return Math.floor(seconds / 86400) + ' –¥–Ω –Ω–∞–∑–∞–¥';
}

function updateTimeAgo() {
    const el = document.getElementById('last-update');
    const time = el.dataset.time;
    if (time) {
        el.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + timeAgo(time);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
updateTimeAgo();
setInterval(updateTimeAgo, 60000);

async function refreshStatus() {
    const btn = document.getElementById('refresh-btn');
    const lastUpdate = document.getElementById('last-update');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    lastUpdate.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    
    try {
        const res = await fetch('/api/refresh', { method: 'POST' });
        const data = await res.json();
        
        if (data.ok) {
            lastUpdate.dataset.time = data.last_update;
            updateTimeAgo();
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            location.reload();
        } else {
            lastUpdate.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
        }
    } catch (e) {
        lastUpdate.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    }
    
    btn.disabled = false;
    btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
}
</script>
{% endblock %}
