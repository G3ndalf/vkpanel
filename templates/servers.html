{% extends "base.html" %}

{% block title %}–°–µ—Ä–≤–µ—Ä—ã ‚Äî VK IP Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>üñ• –°–µ—Ä–≤–µ—Ä—ã</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span id="last-update" style="color: #64748b; font-size: 0.9rem;" data-time="{{ last_update or '' }}">
            {% if last_update %}
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ...
            {% else %}
            –ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å
            {% endif %}
        </span>
        <button id="refresh-all-btn" class="btn btn-primary" onclick="refreshAll()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
        </button>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ -->
<div class="card">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
    <form method="POST" action="/servers/add">
        <div class="form-row">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: vps-1" required>
            </div>
            <div class="form-group">
                <label>–•–æ—Å—Ç (IP)</label>
                <input type="text" name="host" placeholder="192.168.1.1" required>
            </div>
            <div class="form-group">
                <label>–ü–æ—Ä—Ç SSH</label>
                <input type="number" name="port" value="22">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <input type="text" name="user" placeholder="root" required>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å SSH">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">üìã –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ ({{ servers|length }})</h2>
        {% if servers %}
        <div class="actions">
            <button class="btn btn-secondary btn-sm" onclick="expandAll()">‚ñº –†–∞—Å–∫—Ä—ã—Ç—å –≤—Å–µ</button>
            <button class="btn btn-secondary btn-sm" onclick="collapseAll()">‚ñ≤ –°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
        </div>
        {% endif %}
    </div>
    
    {% if servers %}
    <div class="servers-list">
        {% for server in servers %}
        <div class="server-item" data-server-id="{{ server.id }}">
            <div class="server-header" onclick="toggleServer({{ server.id }})">
                <div class="server-info">
                    <span class="server-arrow" id="arrow-{{ server.id }}">‚ñ∂</span>
                    <strong>{{ server.name }}</strong>
                    <code class="ip-code" style="margin-left: 1rem;">{{ server.host }}</code>
                    <span style="color: #64748b; margin-left: 1rem;">{{ server.user }}@:{{ server.port }}</span>
                </div>
                <div class="server-meta">
                    {% set running_count = [] %}
                    {% for script in server.scripts %}
                        {% set cache_key = server.id|string + '-' + script.id|string %}
                        {% if status_cache.get(cache_key, {}).get('running') %}
                            {% set _ = running_count.append(1) %}
                        {% endif %}
                    {% endfor %}
                    <span class="badge" style="background: rgba(16,185,129,0.2); color: #10b981; margin-right: 0.5rem;">
                        {{ running_count|length }}/{{ server.scripts|length }} —Ä–∞–±–æ—Ç–∞—é—Ç
                    </span>
                    <form method="POST" action="/servers/{{ server.id }}/delete" style="display:inline;" 
                          onsubmit="event.stopPropagation(); return confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä {{ server.name }}?');">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="event.stopPropagation();">‚úï</button>
                    </form>
                </div>
            </div>
            
            <div class="server-scripts" id="scripts-{{ server.id }}" style="display: none;">
                {% if server.scripts %}
                <table style="margin: 0;">
                    <thead>
                        <tr>
                            <th>–°–∫—Ä–∏–ø—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ê–∫–∫–∞—É–Ω—Ç / –ü—Ä–æ–µ–∫—Ç</th>
                            <th>–¶–∏–∫–ª–æ–≤</th>
                            <th>–£—Å–ø–µ—Ö–æ–≤</th>
                            <th>–°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for script in server.scripts %}
                        {% set cache_key = server.id|string + '-' + script.id|string %}
                        {% set status = status_cache.get(cache_key, {}) %}
                        <tr id="script-row-{{ server.id }}-{{ script.id }}">
                            <td><strong>{{ script.name }}</strong></td>
                            <td class="status-cell">
                                {% if status.error %}
                                <span class="badge badge-yellow" title="{{ status.error }}">‚ö†Ô∏è –û—à–∏–±–∫–∞</span>
                                {% elif status.running %}
                                <span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>
                                {% elif status %}
                                <span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                {% else %}
                                <span class="badge" style="background: rgba(100,116,139,0.2); color: #64748b;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 0.8rem; color: #94a3b8;">
                                <div>{{ status.account or '‚Äî' }}</div>
                                <div style="color: #64748b;">{{ status.project or '‚Äî' }}</div>
                            </td>
                            <td>{{ status.cycles or '‚Äî' }}</td>
                            <td>{{ status.success or '‚Äî' }}</td>
                            <td>
                                <div class="project-selector">
                                    <select id="project-{{ server.id }}-{{ script.id }}" class="project-select">
                                        <option value="">‚Äî –í—ã–±—Ä–∞—Ç—å ‚Äî</option>
                                        {% for project in projects %}
                                        <option value="{{ project.name }}">{{ project.name }} ({{ project.free_ips }}üÜì / {{ project.attached_ips }}üìå)</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" 
                                            onclick="changeProject({{ server.id }}, {{ script.id }})"
                                            id="btn-{{ server.id }}-{{ script.id }}">
                                        ‚Üí
                                    </button>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-secondary btn-sm" 
                                        onclick="refreshScript({{ server.id }}, {{ script.id }}, this)"
                                        title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                                    üîÑ
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="padding: 1rem; color: #64748b; text-align: center;">
                    –°–∫—Ä–∏–ø—Ç–æ–≤ –Ω–µ—Ç
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty">
        <p>–°–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –≤—ã—à–µ.</p>
    </div>
    {% endif %}
</div>

<style>
.servers-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.server-item {
    border: 1px solid #334155;
    border-radius: 8px;
    overflow: hidden;
}

.server-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(0,0,0,0.2);
    cursor: pointer;
    transition: background 0.2s;
}

.server-header:hover {
    background: rgba(0,0,0,0.3);
}

.server-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.server-arrow {
    display: inline-block;
    transition: transform 0.2s;
    color: #64748b;
    width: 1rem;
}

.server-arrow.expanded {
    transform: rotate(90deg);
}

.server-meta {
    display: flex;
    align-items: center;
}

.server-scripts {
    padding: 1rem;
    background: rgba(0,0,0,0.1);
    border-top: 1px solid #334155;
}

.project-selector {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.project-select {
    padding: 0.3rem 0.4rem;
    border-radius: 6px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 0.75rem;
    min-width: 120px;
}

.project-select:focus {
    outline: none;
    border-color: #f59e0b;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function timeAgo(dateStr) {
    if (!dateStr) return '–ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å';
    
    const date = new Date(dateStr.replace(' ', 'T'));
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 0) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (seconds < 120) return '1 –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 7200) return '1 —á–∞—Å –Ω–∞–∑–∞–¥';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' —á –Ω–∞–∑–∞–¥';
    return Math.floor(seconds / 86400) + ' –¥–Ω –Ω–∞–∑–∞–¥';
}

function updateTimeAgo() {
    const el = document.getElementById('last-update');
    const time = el.dataset.time;
    if (time) {
        el.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + timeAgo(time);
    }
}

updateTimeAgo();
setInterval(updateTimeAgo, 60000);

function toggleServer(serverId) {
    const scripts = document.getElementById(`scripts-${serverId}`);
    const arrow = document.getElementById(`arrow-${serverId}`);
    
    if (scripts.style.display === 'none') {
        scripts.style.display = 'block';
        arrow.classList.add('expanded');
    } else {
        scripts.style.display = 'none';
        arrow.classList.remove('expanded');
    }
}

function expandAll() {
    document.querySelectorAll('.server-scripts').forEach(el => {
        el.style.display = 'block';
    });
    document.querySelectorAll('.server-arrow').forEach(el => {
        el.classList.add('expanded');
    });
}

function collapseAll() {
    document.querySelectorAll('.server-scripts').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.server-arrow').forEach(el => {
        el.classList.remove('expanded');
    });
}

async function refreshAll() {
    const btn = document.getElementById('refresh-all-btn');
    const lastUpdate = document.getElementById('last-update');
    
    btn.disabled = true;
    btn.classList.add('btn-loading');
    lastUpdate.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    
    try {
        const res = await fetch('/api/refresh', { 
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await res.json();
        
        if (data.ok) {
            showToast(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.running} —Ä–∞–±–æ—Ç–∞—é—Ç`, 'success');
            lastUpdate.dataset.time = data.last_update;
            updateTimeAgo();
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}

async function refreshScript(serverId, scriptId, btn) {
    btn.disabled = true;
    btn.classList.add('btn-loading');
    
    try {
        const res = await fetch(`/api/status/${serverId}/${scriptId}`, {
            credentials: 'same-origin'
        });
        const data = await res.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
        const row = document.getElementById(`script-row-${serverId}-${scriptId}`);
        if (row) {
            const statusCell = row.querySelector('.status-cell');
            if (data.error) {
                statusCell.innerHTML = `<span class="badge badge-yellow" title="${data.error}">‚ö†Ô∏è –û—à–∏–±–∫–∞</span>`;
            } else if (data.running) {
                statusCell.innerHTML = '<span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>';
            } else {
                statusCell.innerHTML = '<span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
            }
        }
        
        showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}

async function changeProject(serverId, scriptId) {
    const select = document.getElementById(`project-${serverId}-${scriptId}`);
    const btn = document.getElementById(`btn-${serverId}-${scriptId}`);
    const projectName = select.value;
    
    if (!projectName) {
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.classList.add('btn-loading');
    
    try {
        const formData = new FormData();
        formData.append('project_name', projectName);
        
        const res = await fetch(`/api/scripts/${serverId}/${scriptId}/change-project`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await res.json();
        
        if (data.ok) {
            showToast(data.message, 'success');
            select.value = '';
            // –û–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å —Å–∫—Ä–∏–ø—Ç–∞
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || data.message), 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}
</script>
{% endblock %}
