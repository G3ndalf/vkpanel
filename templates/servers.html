{% extends "base.html" %}

{% block title %}–°–µ—Ä–≤–µ—Ä—ã ‚Äî VK IP Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>üñ• –°–µ—Ä–≤–µ—Ä—ã</h1>
</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ -->
<div class="card">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
    <form method="POST" action="/servers/add">
        <div class="form-row">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: vps-1" required>
            </div>
            <div class="form-group">
                <label>–•–æ—Å—Ç (IP)</label>
                <input type="text" name="host" placeholder="192.168.1.1" required>
            </div>
            <div class="form-group">
                <label>–ü–æ—Ä—Ç SSH</label>
                <input type="number" name="port" value="22">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <input type="text" name="user" placeholder="root" required>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å SSH">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">üìã –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ ({{ servers|length }})</h2>
        {% if servers %}
        <div class="actions">
            <button class="btn btn-secondary btn-sm" onclick="expandAll()">‚ñº –†–∞—Å–∫—Ä—ã—Ç—å –≤—Å–µ</button>
            <button class="btn btn-secondary btn-sm" onclick="collapseAll()">‚ñ≤ –°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
        </div>
        {% endif %}
    </div>
    
    {% if servers %}
    <div class="servers-list">
        {% for server in servers %}
        <div class="server-item" data-server-id="{{ server.id }}">
            <div class="server-header" onclick="toggleServer({{ server.id }})">
                <div class="server-info">
                    <span class="server-arrow" id="arrow-{{ server.id }}">‚ñ∂</span>
                    <strong>{{ server.name }}</strong>
                    <code class="ip-code" style="margin-left: 1rem;">{{ server.host }}</code>
                    <span style="color: #64748b; margin-left: 1rem;">{{ server.user }}@:{{ server.port }}</span>
                </div>
                <div class="server-meta">
                    <span class="badge" style="background: rgba(245,158,11,0.2); color: #f59e0b;">
                        {{ server.scripts|length if server.scripts else 0 }} —Å–∫—Ä–∏–ø—Ç–æ–≤
                    </span>
                    <form method="POST" action="/servers/{{ server.id }}/delete" style="display:inline; margin-left: 0.5rem;" 
                          onsubmit="event.stopPropagation(); return confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä {{ server.name }}?');">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="event.stopPropagation();">‚úï</button>
                    </form>
                </div>
            </div>
            
            <div class="server-scripts" id="scripts-{{ server.id }}" style="display: none;">
                {% if server.scripts %}
                <table style="margin: 0;">
                    <thead>
                        <tr>
                            <th>–°–∫—Ä–∏–ø—Ç</th>
                            <th>–ü—É—Ç—å</th>
                            <th>–°–µ—Ä–≤–∏—Å</th>
                            <th>–°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for script in server.scripts %}
                        <tr>
                            <td><strong>{{ script.name }}</strong></td>
                            <td><code style="font-size: 0.8rem;">{{ script.path }}</code></td>
                            <td><code style="font-size: 0.8rem;">{{ script.service_name }}</code></td>
                            <td>
                                <div class="project-selector">
                                    <select id="project-{{ server.id }}-{{ script.id }}" class="project-select">
                                        <option value="">‚Äî –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ‚Äî</option>
                                        {% for project in projects %}
                                        <option value="{{ project.name }}">{{ project.name }} ({{ project.username }})</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" 
                                            onclick="changeProject({{ server.id }}, {{ script.id }})"
                                            id="btn-{{ server.id }}-{{ script.id }}">
                                        –°–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="padding: 1rem; color: #64748b; text-align: center;">
                    –°–∫—Ä–∏–ø—Ç–æ–≤ –Ω–µ—Ç
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty">
        <p>–°–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –≤—ã—à–µ.</p>
    </div>
    {% endif %}
</div>

<style>
.servers-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.server-item {
    border: 1px solid #334155;
    border-radius: 8px;
    overflow: hidden;
}

.server-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(0,0,0,0.2);
    cursor: pointer;
    transition: background 0.2s;
}

.server-header:hover {
    background: rgba(0,0,0,0.3);
}

.server-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.server-arrow {
    display: inline-block;
    transition: transform 0.2s;
    color: #64748b;
    width: 1rem;
}

.server-arrow.expanded {
    transform: rotate(90deg);
}

.server-meta {
    display: flex;
    align-items: center;
}

.server-scripts {
    padding: 1rem;
    background: rgba(0,0,0,0.1);
    border-top: 1px solid #334155;
}

.project-selector {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.project-select {
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 0.8rem;
    min-width: 200px;
}

.project-select:focus {
    outline: none;
    border-color: #f59e0b;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function toggleServer(serverId) {
    const scripts = document.getElementById(`scripts-${serverId}`);
    const arrow = document.getElementById(`arrow-${serverId}`);
    
    if (scripts.style.display === 'none') {
        scripts.style.display = 'block';
        arrow.classList.add('expanded');
    } else {
        scripts.style.display = 'none';
        arrow.classList.remove('expanded');
    }
}

function expandAll() {
    document.querySelectorAll('.server-scripts').forEach(el => {
        el.style.display = 'block';
    });
    document.querySelectorAll('.server-arrow').forEach(el => {
        el.classList.add('expanded');
    });
}

function collapseAll() {
    document.querySelectorAll('.server-scripts').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.server-arrow').forEach(el => {
        el.classList.remove('expanded');
    });
}

async function changeProject(serverId, scriptId) {
    const select = document.getElementById(`project-${serverId}-${scriptId}`);
    const btn = document.getElementById(`btn-${serverId}-${scriptId}`);
    const projectName = select.value;
    
    if (!projectName) {
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.classList.add('btn-loading');
    
    try {
        const formData = new FormData();
        formData.append('project_name', projectName);
        
        const res = await fetch(`/api/scripts/${serverId}/${scriptId}/change-project`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await res.json();
        
        if (data.ok) {
            showToast(data.message, 'success');
            select.value = '';
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || data.message), 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}
</script>
{% endblock %}
