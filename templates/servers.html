{% extends "base.html" %}

{% block title %}–°–µ—Ä–≤–µ—Ä—ã ‚Äî VK IP Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>üñ• –°–µ—Ä–≤–µ—Ä—ã</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span id="last-update" style="color: #64748b; font-size: 0.9rem;" data-time="{{ last_update or '' }}">
            {% if last_update %}
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ...
            {% else %}
            –ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å
            {% endif %}
        </span>
        <button id="refresh-all-btn" class="btn btn-primary" onclick="refreshAll()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
        </button>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ -->
<div class="card">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
    <form method="POST" action="/servers/add">
        <div class="form-row">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: vps-1" required>
            </div>
            <div class="form-group">
                <label>–•–æ—Å—Ç (IP)</label>
                <input type="text" name="host" placeholder="192.168.1.1" required>
            </div>
            <div class="form-group">
                <label>–ü–æ—Ä—Ç SSH</label>
                <input type="number" name="port" value="22">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <input type="text" name="user" placeholder="root" required>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å SSH">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">üìã –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ ({{ servers|length }})</h2>
        {% if servers %}
        <div class="actions">
            <button class="btn btn-secondary btn-sm" onclick="expandAll()">‚ñº –†–∞—Å–∫—Ä—ã—Ç—å –≤—Å–µ</button>
            <button class="btn btn-secondary btn-sm" onclick="collapseAll()">‚ñ≤ –°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
        </div>
        {% endif %}
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
<div id="project-modal" class="modal" onclick="closeModalOnBackdrop(event)">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìÇ –í—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞</h3>
            <button class="modal-close" onclick="closeProjectModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <input type="text" id="project-search" class="project-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="filterProjects()">
            <div id="projects-list" class="projects-list">
                {% set accounts_dict = {} %}
                {% for project in projects %}
                    {% if project.username not in accounts_dict %}
                        {% set _ = accounts_dict.update({project.username: []}) %}
                    {% endif %}
                    {% set _ = accounts_dict[project.username].append(project) %}
                {% endfor %}
                
                {% for username, account_projects in accounts_dict.items() %}
                {% set acc_attached = [] %}
                {% set acc_free = [] %}
                {% for p in account_projects %}
                    {% set _ = acc_attached.extend([1] * p.attached_ips) %}
                    {% set _ = acc_free.extend([1] * p.free_ips) %}
                {% endfor %}
                
                <div class="account-group" data-username="{{ username }}">
                    <div class="account-header">
                        <span class="account-name">üë§ {{ username }}</span>
                        <span class="account-stats">
                            <span class="stat-attached">{{ acc_attached|length }} üìå</span>
                            <span class="stat-free">{{ acc_free|length }} üÜì</span>
                        </span>
                    </div>
                    
                    <div class="account-projects">
                        {% for project in account_projects %}
                        {% set cached = projects_cache.get(project.name, {}) if projects_cache else {} %}
                        {% set ips = cached.get('ips', []) %}
                        <div class="project-card" data-name="{{ project.name }}" data-username="{{ project.username }}" onclick="selectProject('{{ project.name }}')">
                            <div class="project-header">
                                <span class="project-name">üì¶ {{ project.name }}</span>
                                <span class="project-stats">
                                    <span class="stat-attached">{{ project.attached_ips }} üìå</span>
                                    <span class="stat-free">{{ project.free_ips }} üÜì</span>
                                </span>
                            </div>
                            {% if ips %}
                            <div class="ip-grid-modal">
                                {% for ip in ips %}
                                <div class="ip-chip {{ 'attached' if ip.attached else 'free' }}">
                                    <span class="ip-addr">{{ ip.ip }}</span>
                                    {% if ip.server_name %}
                                    <span class="ip-vm">{{ ip.server_name }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="project-empty">–ù–µ—Ç IP</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

    {% if servers %}
    <div class="servers-list">
        {% for server in servers %}
        <div class="server-item" data-server-id="{{ server.id }}">
            <div class="server-header" onclick="toggleServer({{ server.id }})">
                <div class="server-info">
                    <span class="server-arrow" id="arrow-{{ server.id }}">‚ñ∂</span>
                    <strong>{{ server.name }}</strong>
                    <code class="ip-code" style="margin-left: 1rem;">{{ server.host }}</code>
                    <span style="color: #64748b; margin-left: 1rem;">{{ server.user }}@:{{ server.port }}</span>
                </div>
                <div class="server-meta">
                    {% set running_count = [] %}
                    {% for script in server.scripts %}
                        {% set cache_key = server.id|string + '-' + script.id|string %}
                        {% if status_cache.get(cache_key, {}).get('running') %}
                            {% set _ = running_count.append(1) %}
                        {% endif %}
                    {% endfor %}
                    <span class="badge" style="background: rgba(16,185,129,0.2); color: #10b981; margin-right: 0.5rem;">
                        {{ running_count|length }}/{{ server.scripts|length }} —Ä–∞–±–æ—Ç–∞—é—Ç
                    </span>
                    <form method="POST" action="/servers/{{ server.id }}/delete" style="display:inline;" 
                          onsubmit="event.stopPropagation(); return confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä {{ server.name }}?');">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="event.stopPropagation();">‚úï</button>
                    </form>
                </div>
            </div>
            
            <div class="server-scripts" id="scripts-{{ server.id }}" style="display: none;">
                {% if server.scripts %}
                <table style="margin: 0;">
                    <thead>
                        <tr>
                            <th>–°–∫—Ä–∏–ø—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ê–∫–∫–∞—É–Ω—Ç / –ü—Ä–æ–µ–∫—Ç</th>
                            <th>–¶–∏–∫–ª–æ–≤</th>
                            <th>–£—Å–ø–µ—Ö–æ–≤</th>
                            <th>–°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for script in server.scripts %}
                        {% set cache_key = server.id|string + '-' + script.id|string %}
                        {% set status = status_cache.get(cache_key, {}) %}
                        <tr id="script-row-{{ server.id }}-{{ script.id }}">
                            <td><strong>{{ script.name }}</strong></td>
                            <td class="status-cell">
                                {% if status.error %}
                                <span class="badge badge-yellow" title="{{ status.error }}">‚ö†Ô∏è –û—à–∏–±–∫–∞</span>
                                {% elif status.running %}
                                <span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>
                                {% elif status %}
                                <span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                {% else %}
                                <span class="badge" style="background: rgba(100,116,139,0.2); color: #64748b;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 0.8rem; color: #94a3b8;">
                                <div>{{ status.account or '‚Äî' }}</div>
                                <div style="color: #64748b;">{{ status.project or '‚Äî' }}</div>
                            </td>
                            <td>{{ status.cycles or '‚Äî' }}</td>
                            <td>{{ status.success or '‚Äî' }}</td>
                            <td>
                                <button type="button" class="btn btn-secondary btn-sm"
                                        onclick="openProjectModal({{ server.id }}, {{ script.id }})">
                                    üìÇ –°–º–µ–Ω–∏—Ç—å
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-secondary btn-sm" 
                                        onclick="refreshScript({{ server.id }}, {{ script.id }}, this)"
                                        title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                                    üîÑ
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="padding: 1rem; color: #64748b; text-align: center;">
                    –°–∫—Ä–∏–ø—Ç–æ–≤ –Ω–µ—Ç
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty">
        <p>–°–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –≤—ã—à–µ.</p>
    </div>
    {% endif %}
</div>

<style>
.servers-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.server-item {
    border: 1px solid #334155;
    border-radius: 8px;
    overflow: hidden;
}

.server-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(0,0,0,0.2);
    cursor: pointer;
    transition: background 0.2s;
}

.server-header:hover {
    background: rgba(0,0,0,0.3);
}

.server-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.server-arrow {
    display: inline-block;
    transition: transform 0.2s;
    color: #64748b;
    width: 1rem;
}

.server-arrow.expanded {
    transform: rotate(90deg);
}

.server-meta {
    display: flex;
    align-items: center;
}

.server-scripts {
    padding: 1rem;
    background: rgba(0,0,0,0.1);
    border-top: 1px solid #334155;
}

.project-selector {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.project-select {
    padding: 0.3rem 0.4rem;
    border-radius: 6px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 0.75rem;
    min-width: 120px;
}

.project-select:focus {
    outline: none;
    border-color: #f59e0b;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: #1e293b;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    border: 1px solid #334155;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #334155;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
}

.modal-close {
    background: none;
    border: none;
    color: #64748b;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.modal-close:hover {
    color: #ef4444;
}

.modal-body {
    padding: 1rem;
    overflow-y: auto;
    max-height: calc(80vh - 60px);
}

.project-search {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.project-search:focus {
    outline: none;
    border-color: #f59e0b;
}

.projects-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.project-card {
    background: rgba(0,0,0,0.2);
    border: 1px solid #334155;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.project-card:hover {
    background: rgba(245,158,11,0.1);
    border-color: #f59e0b;
}

.project-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.project-name {
    font-weight: 600;
    color: #f59e0b;
    font-size: 1rem;
}

.project-stats {
    display: flex;
    gap: 0.75rem;
    font-size: 0.85rem;
}

.stat-free {
    color: #10b981;
}

.stat-attached {
    color: #64748b;
}

.project-account {
    color: #94a3b8;
    font-size: 0.85rem;
    margin-bottom: 0.75rem;
}

.ip-grid-modal {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.5rem;
}

.ip-chip {
    padding: 0.3rem 0.6rem;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
}

.ip-chip.attached {
    background: rgba(16, 185, 129, 0.25);
    border: 1px solid rgba(16, 185, 129, 0.4);
}

.ip-chip.free {
    background: rgba(100, 116, 139, 0.15);
    border: 1px solid rgba(100, 116, 139, 0.25);
}

.ip-addr {
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.75rem;
    color: #e2e8f0;
}

.ip-chip.attached .ip-addr {
    color: #10b981;
}

.ip-vm {
    font-size: 0.65rem;
    color: #64748b;
}

.ip-chip.attached .ip-vm {
    color: #6ee7b7;
}

.project-empty {
    color: #64748b;
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

/* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º */
.account-group {
    margin-bottom: 1rem;
    border: 1px solid #334155;
    border-radius: 8px;
    overflow: hidden;
}

.account-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(245, 158, 11, 0.1);
    border-bottom: 1px solid #334155;
}

.account-name {
    font-weight: 600;
    color: #f59e0b;
    font-size: 0.95rem;
}

.account-stats {
    display: flex;
    gap: 0.75rem;
    font-size: 0.85rem;
}

.account-projects {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.account-projects .project-card {
    border: none;
    border-radius: 0;
    border-bottom: 1px solid #334155;
    margin: 0;
}

.account-projects .project-card:last-child {
    border-bottom: none;
}

.account-projects .project-card:hover {
    border-radius: 0;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function toggleServer(serverId) {
    const scripts = document.getElementById(`scripts-${serverId}`);
    const arrow = document.getElementById(`arrow-${serverId}`);
    
    if (scripts.style.display === 'none') {
        scripts.style.display = 'block';
        arrow.classList.add('expanded');
    } else {
        scripts.style.display = 'none';
        arrow.classList.remove('expanded');
    }
}

function expandAll() {
    document.querySelectorAll('.server-scripts').forEach(el => {
        el.style.display = 'block';
    });
    document.querySelectorAll('.server-arrow').forEach(el => {
        el.classList.add('expanded');
    });
}

function collapseAll() {
    document.querySelectorAll('.server-scripts').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.server-arrow').forEach(el => {
        el.classList.remove('expanded');
    });
}

async function refreshAll() {
    const btn = document.getElementById('refresh-all-btn');
    const lastUpdate = document.getElementById('last-update');
    
    btn.disabled = true;
    btn.classList.add('btn-loading');
    lastUpdate.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    
    try {
        const res = await fetch('/api/refresh', { 
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await res.json();
        
        if (data.ok) {
            showToast(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.running} —Ä–∞–±–æ—Ç–∞—é—Ç`, 'success');
            lastUpdate.dataset.time = data.last_update;
            updateTimeAgo();
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}

async function refreshScript(serverId, scriptId, btn) {
    btn.disabled = true;
    btn.classList.add('btn-loading');
    
    try {
        const res = await fetch(`/api/status/${serverId}/${scriptId}`, {
            credentials: 'same-origin'
        });
        const data = await res.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
        const row = document.getElementById(`script-row-${serverId}-${scriptId}`);
        if (row) {
            const statusCell = row.querySelector('.status-cell');
            if (data.error) {
                statusCell.innerHTML = `<span class="badge badge-yellow" title="${data.error}">‚ö†Ô∏è –û—à–∏–±–∫–∞</span>`;
            } else if (data.running) {
                statusCell.innerHTML = '<span class="badge badge-green">–†–∞–±–æ—Ç–∞–µ—Ç</span>';
            } else {
                statusCell.innerHTML = '<span class="badge badge-red">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
            }
        }
        
        showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.classList.remove('btn-loading');
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
let currentServerId = null;
let currentScriptId = null;

function openProjectModal(serverId, scriptId) {
    currentServerId = serverId;
    currentScriptId = scriptId;
    document.getElementById('project-modal').classList.add('active');
    document.getElementById('project-search').value = '';
    filterProjects();
    document.getElementById('project-search').focus();
}

function closeProjectModal() {
    document.getElementById('project-modal').classList.remove('active');
    currentServerId = null;
    currentScriptId = null;
}

function closeModalOnBackdrop(event) {
    if (event.target.id === 'project-modal') {
        closeProjectModal();
    }
}

function filterProjects() {
    const search = document.getElementById('project-search').value.toLowerCase();
    const groups = document.querySelectorAll('.account-group');
    
    groups.forEach(group => {
        const username = group.dataset.username.toLowerCase();
        const cards = group.querySelectorAll('.project-card');
        let visibleCount = 0;
        
        cards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            
            if (name.includes(search) || username.includes(search)) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É –µ—Å–ª–∏ –Ω–µ—Ç –≤–∏–¥–∏–º—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
        group.style.display = visibleCount > 0 ? 'block' : 'none';
    });
}

async function selectProject(projectName) {
    if (!currentServerId || !currentScriptId) return;
    
    closeProjectModal();
    showToast('–ú–µ–Ω—è–µ–º –ø—Ä–æ–µ–∫—Ç...', 'info');
    
    try {
        const formData = new FormData();
        formData.append('project_name', projectName);
        
        const res = await fetch(`/api/scripts/${currentServerId}/${currentScriptId}/change-project`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await res.json();
        
        if (data.ok) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || data.message), 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeProjectModal();
    }
});
</script>
{% endblock %}
