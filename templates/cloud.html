{% extends "base.html" %}

{% block title %}VK Cloud IP ‚Äî VK IP Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>‚òÅÔ∏è Floating IP –∏–∑ VK Cloud</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span id="last-update" style="color: #64748b; font-size: 0.9rem;" data-time="{{ last_update or '' }}">
            {% if last_update %}
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ...
            {% else %}
            –ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å
            {% endif %}
        </span>
        <button id="refresh-btn" class="btn btn-primary" onclick="refreshCloud()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">–í—Å–µ–≥–æ IP</div>
        <div class="value">{{ stats.total }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–ü—Ä–∏–≤—è–∑–∞–Ω–æ –∫ VM</div>
        <div class="value" style="color: #10b981;">{{ stats.attached }}</div>
    </div>
    <div class="stat-card">
        <div class="label">–°–≤–æ–±–æ–¥–Ω–æ</div>
        <div class="value" style="color: #f59e0b;">{{ stats.free }}</div>
    </div>
</div>

<div class="card">
    <h2>üìã –í—Å–µ Floating IP ({{ all_ips|length }})</h2>
    
    {% if all_ips %}
    <table>
        <thead>
            <tr>
                <th>IP –∞–¥—Ä–µ—Å</th>
                <th>–ê–∫–∫–∞—É–Ω—Ç</th>
                <th>–ü—Ä–æ–µ–∫—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>Fixed IP</th>
            </tr>
        </thead>
        <tbody>
            {% for ip in all_ips %}
            <tr>
                <td><code class="ip-code" style="color: #f59e0b; font-size: 1rem;">{{ ip.ip }}</code></td>
                <td style="font-size: 0.85rem;">{{ ip.account or '-' }}</td>
                <td style="font-size: 0.85rem; color: #94a3b8;">{{ ip.project or '-' }}</td>
                <td>
                    {% if ip.attached %}
                    <span class="badge badge-green">–ü—Ä–∏–≤—è–∑–∞–Ω –∫ VM</span>
                    {% else %}
                    <span class="badge badge-yellow">–°–≤–æ–±–æ–¥–µ–Ω</span>
                    {% endif %}
                </td>
                <td style="font-size: 0.85rem; color: #64748b;">{{ ip.fixed_ip or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ VK Cloud</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function timeAgo(dateStr) {
    if (!dateStr) return '–ï—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å';
    
    const date = new Date(dateStr.replace(' ', 'T') + 'Z');
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (seconds < 120) return '1 –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (seconds < 7200) return '1 —á–∞—Å –Ω–∞–∑–∞–¥';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' —á –Ω–∞–∑–∞–¥';
    if (seconds < 172800) return '1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥';
    return Math.floor(seconds / 86400) + ' –¥–Ω –Ω–∞–∑–∞–¥';
}

function updateTimeAgo() {
    const el = document.getElementById('last-update');
    const time = el.dataset.time;
    if (time) {
        el.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + timeAgo(time);
    }
}

updateTimeAgo();
setInterval(updateTimeAgo, 60000);

async function refreshCloud() {
    const btn = document.getElementById('refresh-btn');
    const lastUpdate = document.getElementById('last-update');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
    lastUpdate.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ VK Cloud...';
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç
        
        const res = await fetch('/api/cloud/refresh', { 
            method: 'POST',
            signal: controller.signal,
            credentials: 'same-origin'
        });
        clearTimeout(timeoutId);
        const data = await res.json();
        
        if (data.ok) {
            lastUpdate.dataset.time = data.last_update;
            updateTimeAgo();
            location.reload();
        } else {
            lastUpdate.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
        }
    } catch (e) {
        lastUpdate.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    }
    
    btn.disabled = false;
    btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
}
</script>
{% endblock %}
